---
title: 互联网协议入门
copyright: true
date: 2018-03-08 11:25:14
updated:
comments:
tags:
categories:
layout:
permalink:
top:
password:
---

昨天在下班路上看到阮一峰写的互联网协议入门的两篇文章，被其通俗易懂的输出风格深深折服，很精彩。啊康师

接受了这么有用且强大的输入，忍不住想用自己的语言进行一下个人理解的输出，方便自己以后整理查看。

<!-- more -->

## 入门
我们每天都在使用互联网，但你有没有想过世界上那么多台电脑，它们之间是如何进行交互
的？你在中国发个消息，远在美国的朋友竟然收到了，这之间到底经历了什么？带着这两个
问题我一步步去分析你的消息是如何一步步从中国发送到美国的。

> 互联网的核心是一系列协议，总称为"互联网协议"（Internet Protocol Suite）。它们对
  电脑如何连接和组网，做出了详尽的规定。理解了这些协议，就理解了互联网的原理。

## 五层模型
![互联网五层模型结构图](/upload_image/20180308network.png "互联网五层模型结构图")

一般而言将互联网分成五层，最底下的一层叫做"实体层"（Physical Layer），最上面的
一层叫做"应用层"（Application Layer），中间的三层（自下而上）分别是"链接层"
（Link Layer）、"网络层"（Network Layer）和"传输层"（Transport Layer）。
越下面的层，越靠近硬件；越上面的层，越靠近用户。

每一层都是为了完成一种功能。为了实现这些功能，就需要大家都遵守共同的规则。
大家都遵守的规则，就叫做"协议"（protocol）。
互联网的每一层，都定义了很多协议。这些协议的总称，就叫做"互联网协议"。

## 实体层
最底下的一层，它就是把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，比如
使用光纤连接而不是铁丝连接，作用是负责传送0和1的电信号。

## 链接层
### 定义
单纯的0和1没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？
这就是"链接层"的功能，它在"实体层"的上方，确定了0和1的分组方式。即把发送过来的一大
串0和1进行分组，类比我们把一大段话用各种标点符号进行分割（仅仅用来类比）
### 以太网协议
早期的时候，每家公司都有自己的电信号分组方式。逐渐地，一种叫做"以太网"（Ethernet）的协议，占据了主导地位。
以太网规定，一组电信号构成一个数据包，叫做"帧"（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）。
"标头"包含数据包的一些说明项，比如发送者、接受者、数据类型等等；"数据"则是数据包的具体内容。
"标头"的长度，固定为18字节。"数据"的长度，最短为46字节，最长为1500字节。因此，整个"帧"最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送。
注意：标头固定18字节，注意单位为字节（1字节=8位）
### MAC地址（Media Access Control Address）以太网地址
以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。
网卡地址即MAC地址，每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个十六进制数表示。
前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。
### 广播
以太网数据包必须知道接收方的MAC地址，然后才能发送。
有了数据包的定义、网卡的MAC地址、广播的发送方式，"链接层"就可以在多台计算机之间传送数据了。

## 网络层
### 网络层的由来
互联网是无数子网络共同组成的一个巨型网络
网络层是用来区分哪些MAC地址属于同一个子网络，哪些不是
如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。（"路由"的意思，就是指如何向不同的子网络分发数据包）
遗憾的是，MAC地址本身无法做到这一点。它只与厂商有关，与所处网络无关。
这就导致了"网络层"的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做"网络地址"，简称"网址"。
网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡。因此，从逻辑上可以推断，必定是先处理网络地址，然后再处理MAC地址。
### IP协议
规定网络地址的协议，叫做IP协议。它所定义的地址，就被称为IP地址。
目前，广泛采用的是IP协议第四版，简称IPv4。这个版本规定，网络地址由32个二进制位组成。
习惯上，我们用分成四段的十进制数表示IP地址，从0.0.0.0一直到255.255.255.255。
所谓"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。
知道"子网掩码"，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），
然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。
总结一下，IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。
### IP数据包
根据IP协议发送的数据，就叫做IP数据包。不难想象，其中必定包括IP地址信息。

IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。
因此，理论上，一个IP数据包的"数据"部分，最长为65,515字节。
前面说过，以太网数据包的"数据"部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。

一块网卡怎么会知道另一块网卡的MAC地址？
回答是有一种ARP协议
通常情况下：对方的IP地址是已知的（后文会解释），但是我们不知道它的MAC地址。所以，我们需要一种机制，能够从IP地址得到MAC地址。
    第一种情况，如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理。

    第二种情况，如果两台主机在同一个子网络，那么我们可以用ARP协议，得到对方的MAC地址。
    ARP协议也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，（注意这里：通过IP去反查MAC地址）
    在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。
    它所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。
    如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。

    总之，有了ARP协议之后，我们就可以得到同一个子网络内的主机MAC地址，可以把数据包发送到任意一台子网络内的主机之上了。

## 传输层
也就是说，我们还需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做"端口"（port），
它其实是每一个使用网卡的程序的编号。每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。

"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。
不管是浏览网页还是在线聊天，应用程序会随机选用一个端口，然后与服务器的相应端口联系。

"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，
我们就能实现程序之间的交流。因此，Unix系统就把主机+端口，叫做"套接字"（socket）。有了它，就可以进行网络应用程序开发了。

### UDP协议
UDP数据包非常简单，"标头"部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。

### TCP协议
TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

## 应用层
由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。
"应用层"的作用，就是规定应用程序的数据格式。这些应用程序协议就构成了"应用层"



[参考博客]http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html
[参考博客]http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html

